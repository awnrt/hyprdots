#!/bin/sh

# Displays today's precipication chance (â˜”), and daily low (ðŸ¥¶) and high (ðŸŒž).
# Usually intended for the statusbar.
LOCATION="Moscow"
url="${WTTRURL:-wttr.in}"
weatherreport="${XDG_CACHE_HOME:-$HOME/.cache}/weatherreport"

# Get a weather report from 'wttr.in' and save it locally.
getforecast() { timeout --signal=1 2s curl -sf "$url/$LOCATION" > "$weatherreport" || exit 1; }

getprecipchance() {
	echo "$weatherdata" | sed '16q;d' |    # Extract line 16 from file
		grep -wo "[0-9]*%" |           # Find a sequence of digits followed by '%'
		sort -rn |                     # Sort in descending order
		head -1q                       # Extract first line
}

getdailyhighlow() {
	echo "$weatherdata" | sed '13q;d' |      # Extract line 13 from file
		grep -o "m\\([-+]\\)*[0-9]\\+" | # Find temperatures in the format "m<signed number>"
		sed 's/[+m]//g' |                # Remove '+' and 'm'
		sort -g |                        # Sort in ascending order
		sed -e 1b -e '$!d'               # Extract the first and last lines
}

readfile() { weatherdata="$(cat "$weatherreport")" ;}

showweather() {
	readfile
	printf "â˜”%s ðŸ¥¶%sÂ° ðŸŒž%sÂ°\n" "$(getprecipchance)" $(getdailyhighlow)
}

openterm() {
  hyprctl dispatch exec "[float; size 1800 1300;]" 'kitty -e sh -c "curl wttr.in; read _"'
}

sendnotif() {
  notify-send "ðŸŒˆ Weather module" "Left click for full forecast."
}

if [ ! -n "$1" ]; then
  getforecast
  showweather
else
  if [ "$1" -eq 1 ]; then
    openterm
  elif [ "$1" -eq 3 ]; then
    sendnotif
  fi
fi

